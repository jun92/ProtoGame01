<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Poker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Dice Styles */
        .die-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid #e5e7eb;
            background-color: white;
            object-fit: cover;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 h-screen flex overflow-hidden font-sans">

    <!-- Left Panel: Poker Hands Reference -->
    <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col shadow-lg z-10">
        <div class="p-4 border-b border-gray-700 bg-gray-850">
            <h2 class="text-xl font-bold text-yellow-400 flex items-center gap-2">
                <span>ðŸ“œ</span> Hand Rankings
            </h2>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">

            <!-- Five of a Kind -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold text-purple-300">Five of a Kind</span>
                    <span class="text-xs bg-purple-900 text-purple-200 px-2 py-0.5 rounded">Highest</span>
                </div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_monkey.png" class="die-icon"><img src="assets/dice_monkey.png"
                        class="die-icon"><img src="assets/dice_monkey.png" class="die-icon"><img
                        src="assets/dice_monkey.png" class="die-icon"><img src="assets/dice_monkey.png"
                        class="die-icon">
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">All five dice show the same animal.</p>
            </div>

            <!-- Four of a Kind -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-blue-300 mb-2">Four of a Kind</div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_tiger.png" class="die-icon"><img src="assets/dice_tiger.png"
                        class="die-icon"><img src="assets/dice_tiger.png" class="die-icon"><img
                        src="assets/dice_tiger.png" class="die-icon"><img src="assets/dice_bear.png"
                        class="die-icon opacity-50">
                </div>
            </div>

            <!-- Full House -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-green-300 mb-2">Full House</div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_lion.png" class="die-icon"><img src="assets/dice_lion.png"
                        class="die-icon"><img src="assets/dice_lion.png" class="die-icon"><img
                        src="assets/dice_horse.png" class="die-icon"><img src="assets/dice_horse.png" class="die-icon">
                </div>
            </div>

            <!-- Straight -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-yellow-300 mb-2">Straight</div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_horse.png" class="die-icon"><img src="assets/dice_bear.png"
                        class="die-icon"><img src="assets/dice_owl.png" class="die-icon"><img src="assets/dice_lion.png"
                        class="die-icon"><img src="assets/dice_tiger.png" class="die-icon">
                </div>
            </div>

            <!-- Three of a Kind -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-orange-300 mb-2">Three of a Kind</div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_owl.png" class="die-icon"><img src="assets/dice_owl.png" class="die-icon"><img
                        src="assets/dice_owl.png" class="die-icon"><img src="assets/dice_tiger.png"
                        class="die-icon opacity-50"><img src="assets/dice_horse.png" class="die-icon opacity-50">
                </div>
            </div>

            <!-- Two Pair -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-pink-300 mb-2">Two Pair</div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_bear.png" class="die-icon"><img src="assets/dice_bear.png"
                        class="die-icon"><img src="assets/dice_monkey.png" class="die-icon"><img
                        src="assets/dice_monkey.png" class="die-icon"><img src="assets/dice_lion.png"
                        class="die-icon opacity-50">
                </div>
            </div>

            <!-- One Pair -->
            <div class="bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                <div class="font-semibold text-gray-300 mb-2">One Pair</div>
                <div class="flex gap-1 justify-center">
                    <img src="assets/dice_horse.png" class="die-icon"><img src="assets/dice_horse.png"
                        class="die-icon"><img src="assets/dice_owl.png" class="die-icon opacity-50"><img
                        src="assets/dice_tiger.png" class="die-icon opacity-50"><img src="assets/dice_monkey.png"
                        class="die-icon opacity-50">
                </div>
            </div>

        </div>
    </aside>

    <!-- Center Panel: Dice Arena -->
    <main class="flex-1 flex flex-col relative bg-green-900">
        <!-- Table Felt Texture/Gradient -->
        <div
            class="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-green-800 via-green-900 to-gray-900 opacity-80 pointer-events-none">
        </div>

        <!-- Header/Top Bar -->
        <div class="relative z-10 p-6 flex justify-between items-start">
            <div>
                <h1 class="text-4xl font-bold text-white drop-shadow-md tracking-wider">DICE POKER</h1>
                <p class="text-green-200 opacity-80">Roll the dice, make a hand!</p>
            </div>
            <div class="bg-black/30 backdrop-blur-sm px-4 py-2 rounded-full border border-white/10">
                <span class="text-sm text-gray-300 uppercase tracking-widest">Current Score</span>
                <div class="text-2xl font-mono text-yellow-400 text-right">0</div>
            </div>
        </div>

        <!-- Dice Rolling Area (Center) -->
        <div class="relative z-10 flex-1 flex flex-col items-center justify-center p-8">

            <!-- Held Dice Container -->
            <div id="held-dice-container"
                class="flex gap-4 mb-8 min-h-[60px] p-4 bg-black/20 rounded-xl border border-white/10 w-full max-w-xl justify-center items-center transition-all">
                <span class="text-gray-500 text-sm italic" id="held-placeholder">Click dice to hold them here</span>
            </div>

            <!-- Dice Container -->
            <div id="dice-arena"
                class="relative w-full max-w-3xl h-80 border-4 border-dashed border-green-700/50 rounded-3xl bg-green-800/20 backdrop-blur-sm mb-8 overflow-hidden transition-all">
                <div id="arena-placeholder"
                    class="absolute inset-0 flex items-center justify-center text-center opacity-50 pointer-events-none">
                    <div>
                        <div class="text-6xl mb-4">ðŸŽ²</div>
                        <p class="text-xl font-medium text-green-100">Dice Arena</p>
                        <p class="text-sm text-green-300">Dice will be rolled here</p>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col items-center gap-4">
                <button id="roll-btn"
                    class="bg-gradient-to-b from-yellow-400 to-yellow-600 hover:from-yellow-300 hover:to-yellow-500 text-black font-bold py-4 px-12 rounded-full shadow-[0_4px_0_rgb(161,98,7),0_8px_16px_rgba(0,0,0,0.3)] active:shadow-none active:translate-y-1 transition-all text-xl uppercase tracking-wider transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
                    Roll Dice
                </button>
                <div class="text-green-300 font-mono text-sm">
                    Rolls Left: <span id="rolls-left" class="text-yellow-400 font-bold text-lg">3</span>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="relative z-10 p-4 text-center text-green-400/40 text-sm">
            Click dice to hold/unhold. 3 rolls per turn.
        </div>
    </main>

    <!-- Right Panel: History -->
    <aside class="w-72 bg-gray-800 border-l border-gray-700 flex flex-col shadow-lg z-10">
        <div class="p-4 border-b border-gray-700 bg-gray-850 flex justify-between items-center">
            <h2 class="text-xl font-bold text-blue-400 flex items-center gap-2">
                <span>ðŸ•’</span> History
            </h2>
            <button class="text-xs text-gray-500 hover:text-gray-300 transition-colors">Clear</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="history-list">
            <!-- History items will be added here -->
        </div>
    </aside>

    <script>
        const rollBtn = document.getElementById('roll-btn');
        const diceArena = document.getElementById('dice-arena');
        const arenaPlaceholder = document.getElementById('arena-placeholder');
        const heldContainer = document.getElementById('held-dice-container');
        const heldPlaceholder = document.getElementById('held-placeholder');
        const rollsLeftSpan = document.getElementById('rolls-left');
        const historyList = document.getElementById('history-list');
        const currentScoreEl = document.querySelector('.text-2xl.font-mono.text-yellow-400.text-right');

        // Game State
        let rollsLeft = 3;
        let heldDiceValues = []; // Array of numbers
        let currentArenaDice = []; // Array of PhysicsDie objects
        let isRolling = false;
        let totalScore = 0;

        // Helper to create a die element
        function createDieElement(value) {
            const die = document.createElement('div');
            die.className = 'absolute shadow-xl cursor-pointer hover:scale-110 transition-transform bg-white rounded-lg overflow-hidden border border-gray-200';
            die.style.width = '48px';
            die.style.height = '48px';

            const img = document.createElement('img');
            img.className = 'w-full h-full object-cover';
            die.appendChild(img);

            updateDieFace(die, value);
            return die;
        }

        function updateDieFace(dieElement, value) {
            const img = dieElement.querySelector('img');
            const map = {
                1: 'assets/dice_horse.png',
                2: 'assets/dice_bear.png',
                3: 'assets/dice_owl.png',
                4: 'assets/dice_lion.png',
                5: 'assets/dice_tiger.png',
                6: 'assets/dice_monkey.png'
            };
            if (img) img.src = map[value];
        }

        // Physics Class for a single Die
        class PhysicsDie {
            constructor(arenaWidth, arenaHeight, startX, startY) {
                this.width = 48;
                this.height = 48;
                this.radius = 28;
                this.arenaWidth = arenaWidth;
                this.arenaHeight = arenaHeight;

                // Initial Position
                if (startX !== undefined && startY !== undefined) {
                    this.x = startX;
                    this.y = startY;
                    this.vx = 0;
                    this.vy = 0;
                    this.stopped = true; // Static if spawned manually
                } else {
                    // Throw Logic
                    this.x = (arenaWidth / 2) - (this.width / 2) + (Math.random() * 120 - 60);
                    this.y = arenaHeight + 50 + (Math.random() * 50);
                    this.vx = (Math.random() - 0.5) * 20;
                    this.vy = -(Math.random() * 15 + 25);
                    this.stopped = false;
                }

                // Rotation
                this.rotation = Math.random() * 360;
                this.rotSpeed = (Math.random() - 0.5) * 30;

                // Physics Properties
                this.friction = 0.98;
                this.wallBounce = 0.6;

                // DOM Element
                this.value = Math.floor(Math.random() * 6) + 1;
                this.element = createDieElement(this.value);

                // Interaction: Click to Hold
                this.element.addEventListener('click', (e) => {
                    if (isRolling) return;
                    holdDie(this);
                });

                diceArena.appendChild(this.element);
            }

            update() {
                if (this.stopped) return;

                // Apply Velocity
                this.x += this.vx;
                this.y += this.vy;
                this.rotation += this.rotSpeed;

                // Wall Collisions
                if (this.x <= 0) { this.x = 0; this.vx = -this.vx * this.wallBounce; }
                if (this.x + this.width >= this.arenaWidth) { this.x = this.arenaWidth - this.width; this.vx = -this.vx * this.wallBounce; }
                if (this.y <= 0) { this.y = 0; this.vy = -this.vy * this.wallBounce; }
                if (this.y + this.height >= this.arenaHeight) {
                    this.y = this.arenaHeight - this.height;
                    this.vy = -this.vy * this.wallBounce;
                    this.vx *= 0.9;
                }

                // Air Friction
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.rotSpeed *= 0.95;

                // Stop Condition
                // Relaxed condition: just check velocity.
                if (Math.abs(this.vx) < 0.1 && Math.abs(this.vy) < 0.1) {
                    this.stopped = true;
                }

                // Tumble Effect
                if (!this.stopped && (Math.abs(this.vx) > 1 || Math.abs(this.vy) > 1)) {
                    if (Math.random() > 0.8) {
                        this.value = Math.floor(Math.random() * 6) + 1;
                        updateDieFace(this.element, this.value);
                    }
                }

                // Render
                this.element.style.transform = `translate(${this.x}px, ${this.y}px) rotate(${this.rotation}deg)`;
            }
        }

        function resolveCollisions(dice) {
            const iterations = 8;
            for (let k = 0; k < iterations; k++) {
                for (let i = 0; i < dice.length; i++) {
                    for (let j = i + 1; j < dice.length; j++) {
                        const d1 = dice[i];
                        const d2 = dice[j];
                        if (d1.stopped && d2.stopped) continue; // Skip if both stopped (optimization)

                        const c1x = d1.x + d1.width / 2;
                        const c1y = d1.y + d1.height / 2;
                        const c2x = d2.x + d2.width / 2;
                        const c2y = d2.y + d2.height / 2;

                        let dx = c2x - c1x;
                        let dy = c2y - c1y;
                        let distance = Math.sqrt(dx * dx + dy * dy);

                        if (distance === 0) { dx = (Math.random() - 0.5); dy = (Math.random() - 0.5); distance = Math.sqrt(dx * dx + dy * dy); }

                        const minDistance = d1.radius + d2.radius;

                        if (distance < minDistance) {
                            const overlap = minDistance - distance;
                            const nx = dx / distance;
                            const ny = dy / distance;
                            const separationFactor = 0.5;

                            d1.x -= nx * overlap * separationFactor;
                            d1.y -= ny * overlap * separationFactor;
                            d2.x += nx * overlap * separationFactor;
                            d2.y += ny * overlap * separationFactor;

                            const dvx = d2.vx - d1.vx;
                            const dvy = d2.vy - d1.vy;
                            const velAlongNormal = dvx * nx + dvy * ny;

                            if (velAlongNormal > 0) continue;

                            const restitution = 0.5;
                            let jVal = -(1 + restitution) * velAlongNormal;
                            jVal /= 2;

                            d1.vx -= jVal * nx;
                            d1.vy -= jVal * ny;
                            d2.vx += jVal * nx;
                            d2.vy += jVal * ny;

                            d1.rotSpeed += (Math.random() - 0.5) * 5;
                            d2.rotSpeed += (Math.random() - 0.5) * 5;
                        }
                    }
                }
            }
        }

        // Hold Logic
        function holdDie(physicsDie) {
            if (heldDiceValues.length >= 5) return;

            // Remove from Arena
            physicsDie.element.remove();
            const index = currentArenaDice.indexOf(physicsDie);
            if (index > -1) currentArenaDice.splice(index, 1);

            // Add to Held
            heldDiceValues.push(physicsDie.value);
            renderHeldDice();

            // Check End Turn
            if (heldDiceValues.length === 5) {
                endTurn();
            }
        }

        function unholdDie(value, index) {
            if (isRolling || rollsLeft === 0) return;

            // Remove from Held
            heldDiceValues.splice(index, 1);
            renderHeldDice();

            // Add back to Arena (Static)
            const arenaWidth = diceArena.clientWidth;
            const arenaHeight = diceArena.clientHeight;
            // Spawn at random position in top half
            const x = Math.random() * (arenaWidth - 50);
            const y = Math.random() * (arenaHeight / 2);

            const newDie = new PhysicsDie(arenaWidth, arenaHeight, x, y);
            newDie.value = value; // Restore value
            updateDieFace(newDie.element, value);

            currentArenaDice.push(newDie);
        }

        function renderHeldDice() {
            heldContainer.innerHTML = '';
            if (heldDiceValues.length === 0) {
                heldContainer.appendChild(heldPlaceholder);
                return;
            }

            heldDiceValues.forEach((val, idx) => {
                const die = createDieElement(val);
                die.className = 'die dice-face relative shadow-md cursor-pointer hover:scale-110 transition-transform'; // Relative for flex container
                die.addEventListener('click', () => unholdDie(val, idx));
                heldContainer.appendChild(die);
            });
        }

        // Scoring Logic
        function evaluateHand(diceValues) {
            const counts = {};
            let sum = 0;
            diceValues.forEach(v => {
                counts[v] = (counts[v] || 0) + 1;
                sum += v;
            });

            const countValues = Object.values(counts).sort((a, b) => b - a); // Sort counts descending
            const uniqueValues = Object.keys(counts).length;
            const sortedDice = [...diceValues].sort((a, b) => a - b);

            // Check Hands
            // 1. Five of a Kind
            if (countValues[0] === 5) {
                return { name: "Five of a Kind", score: 3000 + sum, class: "text-purple-400" };
            }

            // 2. Four of a Kind
            if (countValues[0] === 4) {
                return { name: "Four of a Kind", score: 2000 + sum, class: "text-blue-400" };
            }

            // 3. Full House
            if (countValues[0] === 3 && countValues[1] === 2) {
                return { name: "Full House", score: 1500 + sum, class: "text-green-400" };
            }

            // 4. Straight
            if (uniqueValues === 5 && (sortedDice[4] - sortedDice[0] === 4)) {
                return { name: "Straight", score: 1200 + sum, class: "text-yellow-400" };
            }

            // 5. Three of a Kind
            if (countValues[0] === 3) {
                return { name: "Three of a Kind", score: 800 + sum, class: "text-orange-400" };
            }

            // 6. Two Pair
            if (countValues[0] === 2 && countValues[1] === 2) {
                return { name: "Two Pair", score: 400 + sum, class: "text-pink-400" };
            }

            // 7. One Pair
            if (countValues[0] === 2) {
                return { name: "One Pair", score: 200 + sum, class: "text-gray-300" };
            }

            // 8. High Card (Nothing)
            return { name: "High Card", score: sum, class: "text-gray-500" };
        }

        function endTurn() {
            isRolling = false;
            rollBtn.disabled = false;
            rollBtn.textContent = "New Round";
            rollsLeft = 0;
            rollsLeftSpan.textContent = 0;

            // Calculate Result
            const finalHand = [...heldDiceValues, ...currentArenaDice.map(d => d.value)];
            const result = evaluateHand(finalHand);

            console.log("Turn Ended. Final Hand:", finalHand, "Result:", result);

            // Update Total Score
            totalScore += result.score;
            currentScoreEl.textContent = totalScore.toLocaleString();

            // Add to History
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-700/30 p-3 rounded border border-gray-700 hover:bg-gray-700/50 transition-colors animate-fade-in';

            const map = {
                1: 'assets/dice_horse.png',
                2: 'assets/dice_bear.png',
                3: 'assets/dice_owl.png',
                4: 'assets/dice_lion.png',
                5: 'assets/dice_tiger.png',
                6: 'assets/dice_monkey.png'
            };

            historyItem.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-bold ${result.class}">${result.name}</span>
                    <span class="text-xs text-gray-400">+${result.score}</span>
                </div>
                <div class="flex gap-1 opacity-80 scale-75 origin-left mb-1">
                    ${finalHand.map(v => `<img src="${map[v]}" class="w-6 h-6 rounded border border-gray-600">`).join('')}
                </div>
                <div class="text-xs text-right text-gray-600">${new Date().toLocaleTimeString()}</div>
            `;
            historyList.prepend(historyItem);
        }

        function startNewRound() {
            rollsLeft = 3;
            rollsLeftSpan.textContent = rollsLeft;
            heldDiceValues = [];
            renderHeldDice();

            // Clear Arena
            currentArenaDice.forEach(d => d.element.remove());
            currentArenaDice = [];

            rollBtn.textContent = "Roll Dice";

            // Show placeholder
            if (arenaPlaceholder) {
                arenaPlaceholder.style.opacity = '0.5';
                diceArena.classList.add('border-dashed', 'bg-green-800/20');
                diceArena.classList.remove('bg-green-800/40');
            }
        }

        // Main Roll Logic
        rollBtn.addEventListener('click', () => {
            if (rollBtn.textContent === "New Round") {
                startNewRound();
                return;
            }

            if (rollsLeft <= 0) return;

            // Disable button
            rollBtn.disabled = true;
            isRolling = true;
            rollsLeft--;
            rollsLeftSpan.textContent = rollsLeft;

            // Clear previous arena dice (only the ones in arena, held ones stay)
            currentArenaDice.forEach(d => d.element.remove());
            currentArenaDice = [];

            // Hide placeholder
            if (arenaPlaceholder) {
                arenaPlaceholder.style.opacity = '0';
                diceArena.classList.remove('border-dashed', 'bg-green-800/20');
                diceArena.classList.add('bg-green-800/40');
            }

            // Create new dice
            const diceToSpawn = 5 - heldDiceValues.length;
            const arenaWidth = diceArena.clientWidth;
            const arenaHeight = diceArena.clientHeight;

            for (let i = 0; i < diceToSpawn; i++) {
                currentArenaDice.push(new PhysicsDie(arenaWidth, arenaHeight));
            }

            // Animation Loop
            let animationId;
            const startTime = Date.now();

            function animate() {
                let allStopped = true;

                // 1. Update positions
                currentArenaDice.forEach(die => {
                    die.update();
                    if (!die.stopped) allStopped = false;
                });

                // 2. Resolve Collisions
                resolveCollisions(currentArenaDice);

                // Force stop after 3 seconds
                if (Date.now() - startTime > 3000) {
                    allStopped = true;
                }

                if (!allStopped) {
                    animationId = requestAnimationFrame(animate);
                } else {
                    cancelAnimationFrame(animationId);
                    rollBtn.disabled = false;
                    isRolling = false;

                    // Finalize positions
                    const finalValues = currentArenaDice.map(d => d.value);
                    console.log("Roll Result:", finalValues);

                    // Check Auto-End conditions
                    if (rollsLeft === 0) {
                        endTurn();
                    }
                }
            }

            animate();
        });
    </script>
</body>

</html>